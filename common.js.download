/*
 * (c) Copyright 2005-2013 PaperCut Software International Pty. Ltd.
 */

/* Modernizr 2.6.1 (Custom Build) | MIT & BSD
 * Build: http://modernizr.com/download/#-inlinesvg-shiv-cssclasses-prefixed-teststyles-testprop-testallprops-hasevent-prefixes-domprefixes
 */
;window.Modernizr=function(a,b,c){function B(a){j.cssText=a}function C(a,b){return B(m.join(a+";")+(b||""))}function D(a,b){return typeof a===b}function E(a,b){return!!~(""+a).indexOf(b)}function F(a,b){for(var d in a){var e=a[d];if(!E(e,"-")&&j[e]!==c)return b=="pfx"?e:!0}return!1}function G(a,b,d){for(var e in a){var f=b[a[e]];if(f!==c)return d===!1?a[e]:D(f,"function")?f.bind(d||b):f}return!1}function H(a,b,c){var d=a.charAt(0).toUpperCase()+a.slice(1),e=(a+" "+o.join(d+" ")+d).split(" ");return D(b,"string")||D(b,"undefined")?F(e,b):(e=(a+" "+p.join(d+" ")+d).split(" "),G(e,b,c))}var d="2.6.1",e={},f=!0,g=b.documentElement,h="modernizr",i=b.createElement(h),j=i.style,k,l={}.toString,m=" -webkit- -moz- -o- -ms- ".split(" "),n="Webkit Moz O ms",o=n.split(" "),p=n.toLowerCase().split(" "),q={svg:"http://www.w3.org/2000/svg"},r={},s={},t={},u=[],v=u.slice,w,x=function(a,c,d,e){var f,i,j,k=b.createElement("div"),l=b.body,m=l?l:b.createElement("body");if(parseInt(d,10))while(d--)j=b.createElement("div"),j.id=e?e[d]:h+(d+1),k.appendChild(j);return f=["&#173;",'<style id="s',h,'">',a,"</style>"].join(""),k.id=h,(l?k:m).innerHTML+=f,m.appendChild(k),l||(m.style.background="",g.appendChild(m)),i=c(k,a),l?k.parentNode.removeChild(k):m.parentNode.removeChild(m),!!i},y=function(){function d(d,e){e=e||b.createElement(a[d]||"div"),d="on"+d;var f=d in e;return f||(e.setAttribute||(e=b.createElement("div")),e.setAttribute&&e.removeAttribute&&(e.setAttribute(d,""),f=D(e[d],"function"),D(e[d],"undefined")||(e[d]=c),e.removeAttribute(d))),e=null,f}var a={select:"input",change:"input",submit:"form",reset:"form",error:"img",load:"img",abort:"img"};return d}(),z={}.hasOwnProperty,A;!D(z,"undefined")&&!D(z.call,"undefined")?A=function(a,b){return z.call(a,b)}:A=function(a,b){return b in a&&D(a.constructor.prototype[b],"undefined")},Function.prototype.bind||(Function.prototype.bind=function(b){var c=this;if(typeof c!="function")throw new TypeError;var d=v.call(arguments,1),e=function(){if(this instanceof e){var a=function(){};a.prototype=c.prototype;var f=new a,g=c.apply(f,d.concat(v.call(arguments)));return Object(g)===g?g:f}return c.apply(b,d.concat(v.call(arguments)))};return e}),r.inlinesvg=function(){var a=b.createElement("div");return a.innerHTML="<svg/>",(a.firstChild&&a.firstChild.namespaceURI)==q.svg};for(var I in r)A(r,I)&&(w=I.toLowerCase(),e[w]=r[I](),u.push((e[w]?"":"no-")+w));return e.addTest=function(a,b){if(typeof a=="object")for(var d in a)A(a,d)&&e.addTest(d,a[d]);else{a=a.toLowerCase();if(e[a]!==c)return e;b=typeof b=="function"?b():b,f&&(g.className+=" "+(b?"":"no-")+a),e[a]=b}return e},B(""),i=k=null,function(a,b){function k(a,b){var c=a.createElement("p"),d=a.getElementsByTagName("head")[0]||a.documentElement;return c.innerHTML="x<style>"+b+"</style>",d.insertBefore(c.lastChild,d.firstChild)}function l(){var a=r.elements;return typeof a=="string"?a.split(" "):a}function m(a){var b=i[a[g]];return b||(b={},h++,a[g]=h,i[h]=b),b}function n(a,c,f){c||(c=b);if(j)return c.createElement(a);f||(f=m(c));var g;return f.cache[a]?g=f.cache[a].cloneNode():e.test(a)?g=(f.cache[a]=f.createElem(a)).cloneNode():g=f.createElem(a),g.canHaveChildren&&!d.test(a)?f.frag.appendChild(g):g}function o(a,c){a||(a=b);if(j)return a.createDocumentFragment();c=c||m(a);var d=c.frag.cloneNode(),e=0,f=l(),g=f.length;for(;e<g;e++)d.createElement(f[e]);return d}function p(a,b){b.cache||(b.cache={},b.createElem=a.createElement,b.createFrag=a.createDocumentFragment,b.frag=b.createFrag()),a.createElement=function(c){return r.shivMethods?n(c,a,b):b.createElem(c)},a.createDocumentFragment=Function("h,f","return function(){var n=f.cloneNode(),c=n.createElement;h.shivMethods&&("+l().join().replace(/\w+/g,function(a){return b.createElem(a),b.frag.createElement(a),'c("'+a+'")'})+");return n}")(r,b.frag)}function q(a){a||(a=b);var c=m(a);return r.shivCSS&&!f&&!c.hasCSS&&(c.hasCSS=!!k(a,"article,aside,figcaption,figure,footer,header,hgroup,nav,section{display:block}mark{background:#FF0;color:#000}")),j||p(a,c),a}var c=a.html5||{},d=/^<|^(?:button|map|select|textarea|object|iframe|option|optgroup)$/i,e=/^<|^(?:a|b|button|code|div|fieldset|form|h1|h2|h3|h4|h5|h6|i|iframe|img|input|label|li|link|ol|option|p|param|q|script|select|span|strong|style|table|tbody|td|textarea|tfoot|th|thead|tr|ul)$/i,f,g="_html5shiv",h=0,i={},j;(function(){try{var a=b.createElement("a");a.innerHTML="<xyz></xyz>",f="hidden"in a,j=a.childNodes.length==1||function(){b.createElement("a");var a=b.createDocumentFragment();return typeof a.cloneNode=="undefined"||typeof a.createDocumentFragment=="undefined"||typeof a.createElement=="undefined"}()}catch(c){f=!0,j=!0}})();var r={elements:c.elements||"abbr article aside audio bdi canvas data datalist details figcaption figure footer header hgroup mark meter nav output progress section summary time video",shivCSS:c.shivCSS!==!1,supportsUnknownElements:j,shivMethods:c.shivMethods!==!1,type:"default",shivDocument:q,createElement:n,createDocumentFragment:o};a.html5=r,q(b)}(this,b),e._version=d,e._prefixes=m,e._domPrefixes=p,e._cssomPrefixes=o,e.hasEvent=y,e.testProp=function(a){return F([a])},e.testAllProps=H,e.testStyles=x,e.prefixed=function(a,b,c){return b?H(a,b,c):H(a,"pfx")},g.className=g.className.replace(/(^|\s)no-js(\s|$)/,"$1$2")+(f?" js "+u.join(" "):""),e}(this,this.document);

/*!
 * jQuery imagesLoaded plugin v2.1.1
 * http://github.com/desandro/imagesloaded
 *
 * MIT License. by Paul Irish et al.
 */
(function(c,q){var m="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";c.fn.imagesLoaded=function(f){function n(){var b=c(j),a=c(h);d&&(h.length?d.reject(e,b,a):d.resolve(e));c.isFunction(f)&&f.call(g,e,b,a)}function p(b){k(b.target,"error"===b.type)}function k(b,a){b.src===m||-1!==c.inArray(b,l)||(l.push(b),a?h.push(b):j.push(b),c.data(b,"imagesLoaded",{isBroken:a,src:b.src}),r&&d.notifyWith(c(b),[a,e,c(j),c(h)]),e.length===l.length&&(setTimeout(n),e.unbind(".imagesLoaded",
    p)))}var g=this,d=c.isFunction(c.Deferred)?c.Deferred():0,r=c.isFunction(d.notify),e=g.find("img").add(g.filter("img")),l=[],j=[],h=[];c.isPlainObject(f)&&c.each(f,function(b,a){if("callback"===b)f=a;else if(d)d[b](a)});e.length?e.bind("load.imagesLoaded error.imagesLoaded",p).each(function(b,a){var d=a.src,e=c.data(a,"imagesLoaded");if(e&&e.src===d)k(a,e.isBroken);else if(a.complete&&a.naturalWidth!==q)k(a,0===a.naturalWidth||0===a.naturalHeight);else if(a.readyState||a.complete)a.src=m,a.src=d}):
    n();return d?d.promise(g):g}})(jQuery);
/* Masonry library overrides imagesLoaded, so we'll use our own handle. */
$.fn.pcImagesLoaded = $.fn.imagesLoaded;

/* Add CSRF protection token to AJAX requests. */
$(function() {
  var absoluteUrl = new RegExp('^(?:[a-z]+:)?//', 'i');

  if (window.csrfToken) {
    $.ajaxSetup({
      beforeSend: function(jqXhr) {
        var sendToken = false;

        if (absoluteUrl.test(this.url)) {
          // absolute URL, only send token if the XHR is going to the page's server
          var l = document.createElement('a');
          l.href = this.url;

          if (l.hostname == window.location.hostname && l.port == window.location.port) {
            sendToken = true;
          }
        } else {
          // relative URL, can send
          sendToken = true;
        }

        if (sendToken) {
          jqXhr.setRequestHeader('X-CSRF-Token', csrfToken);
        }
      }
    });
  }
});

/* Whenever forms submit, disable all submit buttons to avoid double presses */
$(function () {
    $("form").submit(function () {
        if (this.target && this.target != '_self') {
            /*
             * Workaround for WebKit bug preventing a form submitting twice to the same action.
             * https://bugs.webkit.org/show_bug.cgi?id=28633
             */
            if ($.browser.webkit) {
                /*
                 * Could test $.browser.version here if we knew which versions the bug affected.
                 *  - confirmed on 533.2
                 *  - NOT on 533.4 (Chrome 5)
                 */
                this.action += (this.action.indexOf('?') == -1 ? '?' : '&');
                this.action += 't=' + new Date().getTime();
            }

            // Don't disable if opening in a new window.
            return;
        }

        // Need to delay here so submit starts before we disable buttons, otherwise the pressed button is not sent to server!
        setTimeout(function () {
            $("input[type=submit]").attr("disabled", "true");
        }, 10);
    });
});

/* JS workaround for choosing the default submit button in a multi-submit form. */
$(function() {
  $('input[type=submit].default-submit').each(function() {
    var $submitButton = $(this);
    $submitButton.closest('form').find('input[type!=submit], select').keypress(function(e) {
      if (isKeypressEventEnterKey(e)) {
        $submitButton.click();
        return false;
      }
    });
  });
});

// pagination link improvements
$(function() {
  var jqPagination = $('.table-box span.pagination');

  // unlinked arrows to icons (first page)
  jqPagination.contents().filter(function() {
    // text node containing "<<"
    return (this.nodeType == 3) && (this.data.indexOf('<<') != -1);
  }).replaceWith('<img class="icon16" src="/images/icons2/16x16/nav-gray-left2.png" /> <img class="icon16" src="/images/icons2/16x16/nav-gray-left.png" /> ');

  // unlinked arrows to icons (last page)
  jqPagination.contents().filter(function() {
    // text node containing ">>"
    return (this.nodeType == 3) && (this.data.indexOf('>>') != -1);
  }).replaceWith(' <img class="icon16" src="/images/icons2/16x16/nav-gray-right.png" /> <img class="icon16" src="/images/icons2/16x16/nav-gray-right2.png" />');

  jqPagination.children('a').each(function() {
    if ($(this).text().indexOf('<<') != -1) $(this).contents().replaceWith('<img class="icon16" src="/images/icons2/16x16/nav-green-left2.png" />');
    if ($(this).text().indexOf('<') != -1) $(this).contents().replaceWith('<img class="icon16" src="/images/icons2/16x16/nav-green-left.png" />');
    if ($(this).text().indexOf('>>') != -1) $(this).contents().replaceWith('<img class="icon16" src="/images/icons2/16x16/nav-green-right2.png" />');
    if ($(this).text().indexOf('>') != -1) $(this).contents().replaceWith('<img class="icon16" src="/images/icons2/16x16/nav-green-right.png" />');
  });

  // thi^H^H^Hmove outside the box
  jqPagination.remove().insertBefore('.table-box');

  // replicate below table
  jqPagination.clone().appendTo('.table-box .table-footer td.pagination');
});

/* function for light box */
$(function() {
    $('a[rel*=lightbox]').each(function() {
        $(this).attr('title', $(this).children('img').attr('title'));
        $(this).lightBox({
            imageLoading: '/images/lightbox/loading.gif',
            imageBtnClose: '/images/lightbox/close.gif',
            imageBlank: '/images/lightbox/blank.gif',
            fixedNavigation: true
            });
        });
});

/*
 * Limit the length of textareas with the 'maxlenth' attribute by binding the MaxLength function to their onkeyup event.
 */
$(function() {
  $('textarea[maxlength]').bind("keyup", function(e) {
    MaxLength(this, $(this).attr('maxlength'));
  });
});



function search(searchTerm, className)  {
  $("." + className + " div").each(function(){
    var x = $(this).text();
    if ($(this).text().toLowerCase().indexOf(searchTerm.toLowerCase()) >=0) {
      $(this).show();
      } else {
        $(this).hide();
      }
  });
}

/*
 * Browser specific hacks.
 */
$(function() {
  if ($.browser.msie) {
    /* IE6 */
    if ($.browser.version.charAt(0) == '6') {
      $('table.results th:last-child').addClass('last-child');
      $('table.results td:first-child').addClass('first-child');
    }
    /* IE7 */
    if ($.browser.version.charAt(0) == '7') {
      $('table.results th:last-child').addClass('last-child');
    }
  }
});

$(function() {
  if ($('').areYouSure && window.messages) {
    $('.dirty-check').areYouSure({
      'message': messages.dirtyFormWarning
    });
  }
});

// http://stackoverflow.com/a/7337485/31440
$.fn.outerHTML = function(arg) {
  var ret;

  // If no items in the collection, return
  if (!this.length) {
    return typeof arg == "undefined" ? this : null;
  }
  // Getter overload (no argument passed)
  if (!arg) {
    return this[0].outerHTML || (ret = this.wrap('<div>').parent().html(), this.unwrap(), ret);
  }
  // Setter overload
  $.each(this, function (i, el) {
    var fnRet, 
        pass = el,
        inOrOut = el.outerHTML ? "outerHTML" : "innerHTML";

    if (!el.outerHTML) {
      el = $(el).wrap('<div>').parent()[0];
    }

    if (jQuery.isFunction(arg)) { 
      if ((fnRet = arg.call(pass, i, el[inOrOut])) !== false) {
        el[inOrOut] = fnRet;
      } else {
        el[inOrOut] = arg;
      }

      if (!el.outerHTML) {
        $(el).children().unwrap();
      }
    }
  });

  return this;
}

/**
 * E.g.: format('Hello {0}', 'World')
 */
function format(template) {
  var msg = template;
  for (var i = 1; i < arguments.length; i++) {
    msg = msg.replace('{' + (i - 1) + '}', arguments[i]);
  }
  return msg;
}

/**
 * E.g. formatNav('Options', 'User/Group Sync') --> 'Options â–¸ User/Group Sync'
 */
function formatNav() {
  var msg = '';
  for (var i = 0; i < arguments.length; i++) {
    if (i > 0) {
      msg += ' &#9656; ';
    }
    msg += arguments[i];
  }
  return msg;
}

function formatWithTapestryLink(options) {
  var textWithLink = format(options.textTemplate, options.tapestryLink.clone().css('display', '').outerHTML());
  options.target.html(textWithLink);
}

/*
* Used to limit the typeable length of a text area.
* This should be called from the onKeyUp event.
*/
function MaxLength(field, maxlength) {
  if ($(field).val().length > maxlength) {
    $(field).val($(field).val().substring(0, maxlength));
  }
}

var __animSpeed = "slow";

function isVisibleJQ(jq) {
    if (jq.length > 0) {
        return jq.get(0).style.display != "none";
    } else {
        return false;
    }
}

function fadeIn(jq, animate) {
    if (isVisibleJQ(jq)) {
        return;
    }
    if (animate) {
        jq.fadeIn(__animSpeed);

        // HACK!!: On IE8 enabling the virtual queue on PrinterDetails won't display the settings (the fadeIn doesn't work).
        //         This hack forces the element to be displayed after the fadeIn().
        jq.show();
    } else {
        jq.show();
    }
}

function fadeOut(jq, animate) {
    if (!isVisibleJQ(jq)) {
        return;
    }
    if (animate) {
        jq.fadeOut(__animSpeed);
    } else {
        jq.hide();
    }
}

function show(jq, animate) {
    if (isVisibleJQ(jq)) {
        return;
    }
    if (animate) {
        jq.show(__animSpeed);
    } else {
        jq.show();
    }
}

function hide(jq, animate) {
    if (!isVisibleJQ(jq)) {
        return;
    }
    if (animate) {
        jq.hide(__animSpeed);
    } else {
        jq.hide();
    }
}

function fadeElement(el, display, animate) {
    if (display) {
        fadeIn($(el), animate);
    } else {
        fadeOut($(el), animate);
    }
}

function showHideElement(el, display, animate) {
    if (display) {
        show($(el), animate);
    } else {
        hide($(el), animate);
    }
}

function displayIfChecked(checkBoxId, blockId, animate, hideIfChecked) {
    var checkBoxEl = document.getElementById(checkBoxId);
    if (!checkBoxEl) {
        return;
    }
    var block = document.getElementById(blockId);
    if (!block) {
        return;
    }
    
    var display = checkBoxEl.checked;
    if (hideIfChecked) {
        display = !display;
    }
    
    fadeElement(block, display, animate);
}

function enableIfChecked(checkBoxId, inputId) {
    var chk = document.getElementById(checkBoxId);
    if (!chk) {
        return;
    }
    var input = document.getElementById(inputId);
    if (!input) {
        return;
    }
    input.disabled = !chk.checked;
}

/**
 * Enable the input field if either of the checkboxes are checked.
 * (i.e. disable if neither are checked)
 */
function enableIfEitherChecked(checkBox1Id, checkBox2Id, inputId) {
    var chk1 = document.getElementById(checkBox1Id);
    if (!chk1) {
        return;
    }
    var chk2 = document.getElementById(checkBox2Id);
    if (!chk2) {
        return;
    }
    var input = document.getElementById(inputId);
    if (!input) {
        return;
    }
    input.disabled = (!chk1.checked && !chk2.checked);
}

/**
 * Hides "block" when "checkbox" is disabled and vice versa.
 *
 * @param checkbox A checkbox (id, node or jQ)
 * @param block The block to hide and show (id, node or jQ)
 */
function checkboxHideShow(checkbox, block) {
  checkbox = jq(checkbox);
  block = jq(block);

  if (checkbox.length == 0 || block.length == 0) {
    return;
  }

  // first time setup without animation
  fadeElement(block[0], checkbox[0].checked, false);

  // bind click event with animation
  checkbox.click(function() {
    fadeElement(block[0], checkbox[0].checked, true);
  });
}

/**
 * It selects all the inputs/checkboxes.
 *
 * @param currentElement The select all checkbox
 * @param inputs All the check boxes that will be selected
 */
function selectAllClicked(currentElement, inputs) {
  var selectAll = currentElement;

  for (var i = 0; i < inputs.length; i++) {
    inputs[i].checked = selectAll.checked;
  }
}


/**
 * It tests whether all the checkboxes have been selected or not.
 * @param inputs All the checkboxes
 * @param selectAllCheckbox The select all checkbox element.
 */
function testSelectAll(inputs, selectAllCheckbox) {
  if (inputs.length == 1) {
    return;
  }
  var allChecked = true;
  for (var i = 0; i < (inputs.length); i++) {
    if (!inputs[i].checked) {
      allChecked = false;
      break;
    }
  }

  selectAllCheckbox.attr('checked', allChecked);
}



/**
 * Shows "block" when "option" (HTML select option) is selected and hides it when deselected.
 *
 * @param option A select option (id, node or jQ)
 * @param block The block to hide and show (id, node or jQ)
 */
function selectOptionHideShow(option, block) {
  option = jq(option);
  block = jq(block);

  if (option.length == 0 || block.length == 0) {
    return;
  }

  var select = option.parent();

  // first time setup without animation
  fadeElement(block[0], select.find('option:selected')[0] == option[0], false);

  // bind change event with animation
  select.change(function() {
    fadeElement(block[0], select.find('option:selected')[0] == option[0], true);
  });
}

/**
 * Disables "input" when "checkbox" is disabled and vice versa.
 *
 * @param checkbox A checkbox (id, node or jQ)
 * @param input The input to enable and disable (id, node or jQ)
 */
function checkboxEnableDisableInput(checkbox, input) {
  checkbox = jq(checkbox);
  input = jq(input);

  if (checkbox.length == 0 || input.length == 0) {
    return;
  }

  input[0].disabled = !checkbox[0].checked;

  checkbox.click(function() {
    input[0].disabled = !checkbox[0].checked;
  });
}

/**
 * Disables "input" when "radio" is disabled and vice versa.
 *
 * @param radio A radio button (id, node or jQ)
 * @param input The input to enable and disable (id, node or jQ)
 */
function radioEnableDisableInput(radio, input) {
  radio = jq(radio);
  input = jq(input);

  if (radio.length == 0 || input.length == 0) {
    return;
  }

  // radio buttons don't issue change event on deselect, so we need to watch all buttons in the group
  var $radioGroupInputs = $("input[type=radio][name='" + radio.attr('name') + "']")

  input[0].disabled = !radio.is(':checked');

  $radioGroupInputs.on('change', function() {
    input[0].disabled = !radio.is(':checked');
  });
}

function enlarge(divId) {
  $("#" + divId).width("60%");
  $('body').width($('body').width() + 200);
}


/**
 * Convert "el" to a jQuery object. "el" may be an existing jQuery object (returns itself), a DOM node (returns the node
 * wrapped in a jQuery object, or a DOM id (uses jQuery to look up and return by id).
 *
 * @param o An object.
 * @return A jQuery object.
 */
function jq(o) {
  if (o.jquery) {
    return o;
  } else if (typeof o === "string") {
    return $('#' + o);
  } else {
    return $(o);
  }
}

jQuery.fn.extend({
  uploadProgress: function(options) {
    var progressUpdate;
    var $form = jQuery(this);

    // default options
    options = jQuery.extend({
      $uploadButton: $('#upload'),
      $progressDisplay: $('#upload-progress'),
      success: function() {},
      failed: function() {}
    }, options);

    var $iframe = $('<iframe id="upload-frame" name="upload-frame" src="about:blank" ' +
                            'style="width: 0; height: 0; border: none; overflow: hidden;"></iframe>');

    // progress display table
    options.$progressDisplay.hide().html('' +
      '<table class="working">' +
      '  <tbody>' +
      '    <tr>' +
      '      <td class="working-1">&nbsp;</td>' +
      '      <td class="working-2">&nbsp;</td>' +
      '      <td class="working-3">&nbsp;</td>' +
      '      <td class="working-4">&nbsp;</td>' +
      '      <td class="working-5">&nbsp;</td>' +
      '      <td class="working-6">&nbsp;</td>' +
      '      <td class="working-7">&nbsp;</td>' +
      '    </tr>' +
      '  </tbody>' +
      '</table>' +
      '<div class="percentage"></div>');
    options.$progressDisplay.after($iframe);

    options.$uploadButton.click(function() {
      $form.submit(function() {
        this.target = $iframe.attr('id');
        this.action = options.uploadFormSubmitURL;
        startUpdater('upload/' + options.uploadUID);
        $iframe.load(function() {
          options.success();
          setTimeout(function() {
            $iframe.remove();
          }, 100);
        });
      });
    });

    return this;

    function startUpdater(url) {
      options.$progressDisplay.show();
      working();
      progressUpdate = setInterval(function() {
        $.get(url, function(responseXML) {
          var percentComplete = $('percent_complete', responseXML).text();
          setProgress(percentComplete);
        });
      }, 3000);
    }

    function setProgress(percent) {
      if (percent == null) {
        working();
      } else {
        var $p = options.$progressDisplay.children('.percentage');
        working(false);
        var duration = (percent == 100) ? 'fast' : 3000;
        $p.animate({width: percent + '%'}, {easing: 'linear', duration: duration});

        if (percent == 100) {
          clearTimeout(progressUpdate);
          $p.addClass('done');
        } else {
          $p.removeClass('done');
        }
      }
    }

    function working(active) {
      var $w = options.$progressDisplay.children('.working');
      if (active == null) {
        active = true;
      }
      if (active) {
        options.$progressDisplay.children('.percentage').hide().css('width', '0');
        $w.show().css('margin-left', '-85px');
        $w.animate({ marginLeft: '300px' }, { easing: 'linear', duration: 3000 });
        workingTimeout = setTimeout(function() { working() }, 3200);
      } else {
        clearTimeout(workingTimeout);
        $w.stop().hide();
      }
    }
  }
});

/**
 * Return true if an DIVs text on overflow:auto has overflowed.
 */
function divHasOverflow(div) {
	//allow 1 pixel diff before deciding that div has overflown
    return div.scrollWidth > (div.clientWidth + 1) || div.scrollHeight > (div.clientHeight + 1);
};

/*
 * jQuery plugin: Image preloader.
 * Preloads all provided image arguments.
 * Usage: $.preLoadImages('/path/to/image1.png', 'image2.png');
 */
(function($) {
  var cache = [];
  // Arguments are image paths relative to the current page.
  $.preLoadImages = function() {
    var args_len = arguments.length;
    for (var i = args_len; i--;) {
      var cacheImage = document.createElement('img');
      cacheImage.src = arguments[i];
      cache.push(cacheImage);
    }
  };
})(jQuery);

RegExp.escape = function(text) {
  return text.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, "\\$&");
}

/**
 * Format a number amount into a string.  E.g. 1234.56 -> "$1,234.56".
 *
 * @param amount {Number} The cost as a number.
 * @param currencyFormatSymbols {object} Symbols used to format the cost.
 * @returns {String} The formatted cost.
 */
function formatCost(amount, currencyFormatSymbols) {
  if (amount === null || amount === '' || isNaN(amount) || amount != parseFloat(amount)) {
    // not a number
    return '';
  }

  var isNegative = amount < 0;
  // decimal places, remove sign
  var formattedAmount = String(Math.abs(amount).toFixed(currencyFormatSymbols.numDecimalsCredit));

  // XXX doesn't handle grouping chars

  // decimal char
  formattedAmount = formattedAmount.replace('.', currencyFormatSymbols.decimalSeparator);

  // prefix and suffix
  if (isNegative) {
    formattedAmount = currencyFormatSymbols.negativePrefix + formattedAmount + currencyFormatSymbols.negativeSuffix;
  } else {
    formattedAmount = currencyFormatSymbols.positivePrefix + formattedAmount + currencyFormatSymbols.positiveSuffix;
  }

  return formattedAmount;
}

/**
 * Parse a string representation of currency credit into a number.  E.g. "$1,234.56" -> 1234.56.
 *
 * @param amountStr {String} The formatted amount to parse, e.g. "$1,234.56".
 * @param currencyFormatSymbols {object} Symbols used to parse the currency.
 * @returns {Number} The parsed number, or NaN if parsing failed.
 */
function parseCurrency(amountStr, currencyFormatSymbols) {
  var isNegative = amountStr.indexOf(currencyFormatSymbols.negativePrefix) == 0;

  amountStr = amountStr.replace(currencyFormatSymbols.groupingSeparator, '');
  if (isNegative) {
    amountStr = amountStr.replace(currencyFormatSymbols.negativePrefix, '');
    amountStr = amountStr.replace(currencyFormatSymbols.negativeSuffix, '');
  } else {
    amountStr = amountStr.replace(currencyFormatSymbols.positivePrefix, '');
    amountStr = amountStr.replace(currencyFormatSymbols.positiveSuffix, '');
  }
  amountStr = amountStr.replace(currencyFormatSymbols.decimalSeparator, '.');

  amountStr = (isNegative ? '-' : '') + amountStr;

  var amount = parseFloat(amountStr);
  return amount;
}

/**
 * @param e The keypress event.
 * @returns {Boolean} True if this event indicates that the enter key was pressed.
 */
function isKeypressEventEnterKey(e) {
  return (e.which && e.which == 13) || (e.keyCode && e.keyCode == 13);
}

/**
 * jQuery plugin: extend a text input with username autocomplete.
 *
 * Usage:
 *   $('input#username').usernameAutocomplete(options);
 * Options (all optional):
 *   maxHeight {Number}: the maximum height of the results box, in px.
 *   selected {function}: function called when a result is selected.
 *     Args: item - a dictionary with keys 'username', 'fullName'.
 * Full example:
 *   $('input#username').usernameAutocomplete({
 *     maxHeight: 300,
 *     selected: function(item) {
 *       $('#full-name').text(item.fullName);
 *     }
 *   });
 */
jQuery.fn.extend({
  usernameAutocomplete: function(options) {
    if (this.length == 0) return this;
    if (!options) options = {};

    if (options.maxHeight) {
      var css = 'overflow-x: hidden; overflow-y: scroll; ';
      css += getMaxHeightCSS(options.maxHeight);
      setGlobalCSS( { '.ui-autocomplete': css } );
    }

    this.attr('autocomplete', 'off');

    this.autocomplete({
      source: function(term, callback) {
        var requestData = { t: term.term };
        $.getJSON('/rpc/api/rest/internal/users', requestData, function(responseData) {
          callback(responseData);
        });
      },
      focus: function(event, ui) {
        $(this).val(ui.item.username);
        return false;
      },
      select: function(event, ui) {
        $(this).val(ui.item.username);
        if (options.selected) options.selected(ui.item);
        return false;
      }
    }).data('autocomplete')._renderItem = function(ul, item) {
      var usernameFormatted = highlightTerm(item.username, this.term);
      var fullNameFormatted = highlightTerm(item.fullName, this.term);
      var itemFormatted = '<div class="username">' + usernameFormatted + '</div><div class="full-name">'
          + fullNameFormatted + '</div>';
      return $('<li></li>')
          .data('item.autocomplete', item)
          .append('<a>' + itemFormatted + '</a>')
          .appendTo(ul);
    };

    return this;

    function highlightTerm(item, term) {
      return item.replace(
          new RegExp(
              "(?![^&;]+;)(?!<[^<>]*)("
                  + $.ui.autocomplete.escapeRegex(term)
                  + ")(?![^<>]*>)(?![^&;]+;)", 'gi'
          ), '<strong>$1</strong>');
    }
  }
});

/**
 * jQuery plugin: extend a text input with shared account autocomplete.
 *
 * Usage:
 *   $('input#shared-account').sharedAccountAutocomplete();
 * With max height:
 *   $('input#username').sharedAccountAutocomplete({
 *     maxHeight: 300
 *   });
 */
jQuery.fn.extend({
  sharedAccountAutocomplete: function(options) {
    if (this.length == 0) return this;
    if (!options) options = {};

    if (options.maxHeight) {
      var css = 'overflow-x: hidden; overflow-y: scroll; ';
      css += getMaxHeightCSS(options.maxHeight);
      setGlobalCSS( { '.ui-autocomplete': css } );
    }

    this.attr('autocomplete', 'off');

    this.autocomplete({
      source: function(term, callback) {
        var requestData = { t: term.term };
        $.getJSON('/rpc/api/rest/internal/shared-accounts', requestData, function(responseData) {
          callback(responseData);
        });
      },
      focus: function(event, ui) {
        $(this).val(ui.item.name);
        return false;
      }, select: function(event, ui) {
        $(this).val(ui.item.name);
        return false;
      }
    }).data('autocomplete')._renderItem = function(ul, item) {
      var nameFormatted = highlightTerm(item.name, this.term);
      var itemFormatted = '<div class="shared-account-name">' + nameFormatted + '</div>';
      return $('<li></li>')
          .data('item.autocomplete', item)
          .append('<a>' + itemFormatted + '</a>')
          .appendTo(ul);
    };

    return this;

    function highlightTerm(item, term) {
      return item.replace(
          new RegExp(
              "(?![^&;]+;)(?!<[^<>]*)("
                  + $.ui.autocomplete.escapeRegex(term)
                  + ")(?![^<>]*>)(?![^&;]+;)", 'gi'
          ), '<strong>$1</strong>');
    }
  }
});

/**
 * Usage:
 *   setGlobalCSS( { selector: rule } );
 * E.g.:
 *   setGlobalCSS( { 'p': 'color: #FFF' } );
 *
 * Calling multiple times with the same selector will result in the existing selector being replaced.
 *
 * @param css Map of CSS rules to add.
 */
function setGlobalCSS(css) {
  if ($('head style[title=global]').length > 0) {
    // sheet already exists
  } else {
    // create sheet
    $('<style type="text/css" rel="stylesheet" media="screen" title="global" />').appendTo('head');
  }

  var styleSheet;

  // get reference to sheet
  // NOTE: can't use $.each on document.styleSheets in IE, see jQuery #4366: http://bugs.jquery.com/ticket/4366
  for (var i = 0; i < document.styleSheets.length; i++) {
    if ($(document.styleSheets[i]).attr('title') == 'global') {
      styleSheet = document.styleSheets[i];
    }
  }

  var cssRules = styleSheet.cssRules ? styleSheet.cssRules : styleSheet.rules;
  var deleteRule = styleSheet.deleteRule ? function(index) {
    styleSheet.deleteRule(index);
  } : function(index) {
    styleSheet.removeRule(index);
  }
  var insertRule = styleSheet.insertRule ? function(selector, rule, index) {
    styleSheet.insertRule(selector + '{' + rule + ';}', 0);
  } : function(selector, rule, index) {
    styleSheet.addRule(selector, rule, index);
  }

  $.each(css, function(selector, rule) {
    // remove existing selector
    for (var i = 0; i < cssRules.length; i++){
      if (cssRules[i].selectorText == selector) {
        deleteRule(i);
      }
    }

    insertRule(selector, rule, 0);
  });
}

/**
 * @param maxHeight {Number} The maximum height in pixels
 * @return {String} Browser independent CSS value to apply maximum height.
 */
function getMaxHeightCSS(maxHeight) {
  var css = 'max-height: ' + maxHeight + 'px;'

  if ($.browser.msie) {
    if ($.browser.version.charAt(0) == '6' || $.browser.version.charAt(0) == '7') {
      // IE6,7 - use expression instead
      css = 'height: expression( this.scrollHeight > ' + (maxHeight - 1) + ' ? "' + maxHeight + 'px" : "auto" );';
    }
  }

  return css;
}

function createStatusMessage(cssClass, iconName, htmlMsg) {
  return $('<div />').addClass(cssClass)
      .append($('<table />').css('border-collapse', 'collapse')
          .append($('<tr />')
              .append($('<td />')
                  .append($('<img />').attr('src', '/images/icons2/24x24/' + iconName + '.png')))
              .append($('<td />')
                  .append(htmlMsg))));
}

function addInfoMessage(msg, $parent) {
  if ($parent === undefined) $parent = $('.status-messages');
  createStatusMessage('infoMessage', 'check', msg)
      .hide()
      .css({ opacity: 0 })
      .appendTo($parent)
      .animate({ height: 'toggle' }, { queue: false, easing: 'linear', duration: 100 })
      .animate({ opacity: 1 }, { queue: false, duration: 500 })
      .delay(7000)
      .promise().done(function() {
        $(this).animate({ height: 'toggle' }, { queue: false, easing: 'linear', duration: 500 })
            .animate({ opacity: 0 }, { queue: false, duration: 1000 })
            .promise().done(function() {
              $(this).remove();
            });
      });
}

function addWarnMessage(msg, $parent) {
  if ($parent === undefined || $parent.length == 0) $parent = $('.status-messages');
  createStatusMessage('warnMessage', 'warning', msg)
      .hide()
      .css({ opacity: 0 })
      .appendTo($parent)
      .animate({ height: 'toggle' }, { queue: false, easing: 'linear', duration: 100 })
      .animate({ opacity: 1 }, { queue: false, duration: 500 });
}

function addErrorMessage(msg, $parent) {
  if ($parent === undefined || $parent.length == 0) $parent = $('.status-messages');
  createStatusMessage('errorMessage', 'error', msg)
      .hide()
      .css({ opacity: 0 })
      .appendTo($parent)
      .animate({ height: 'toggle' }, { queue: false, easing: 'linear', duration: 100 })
      .animate({ opacity: 1 }, { queue: false, duration: 500 });
}

if ($.widget) {
  $.widget('ui.archiveViewer', {
    version: '0.0.1',
    options: {
      archivePath: null,
      jobUid: null,
      totalPages: null,
      pageLimit: null,
      copies: null,
      page: 1,
      transitionSpeedMs: 500,
      grayscale: false,
      // Signals whether admin has the right to remove archive
      canAdminRemoveArchive: false,
      // Signals whether reloading after closing the widget is required
      reloadAfterClose: false
    },

    _create: function() {
      this.options.archivePath = this.options.archivePath || this.element.data('archive-path');
      this.options.jobUid = this.options.jobUid || this.element.data('job-uid');
      this.options.totalPages = this.options.totalPages || this.element.data('total-pages') || 1;
      this.options.copies = this.options.copies || this.element.data('copies') || 1;
      this.options.pageLimit = this.options.pageLimit || this.element.data('max-pages') || 200;
      this.options.grayscale = this.options.grayscale || this.element.data('grayscale') || false;
      this.options.canAdminRemoveArchive = this.options.canAdminRemoveArchive || this.element.data('can-admin-manage-archive') || false;

      // Truncated if we're not showing all available images.
      this.truncated = this.options.totalPages > this.options.pageLimit;
      // If we're truncated we add an additional page displaying what happened.
      this.maxPage = this.truncated ? this.options.pageLimit + 1 : this.options.totalPages;

      if (this.options.archivePath == null) throw 'archivePath is required';
      if (this.options.jobUid == null) throw 'jobUid is required';

      this.downloadUrl = '/archive/pdl/' + encodeURIComponent(this.options.archivePath) + '/' + this.options.jobUid;

      this.destroying = false;
      this.errorRetry = false;
    },

    _init: function() {
      this.element.click($.proxy(function() {
        this.open();
        return false;
      }, this));
    },

    _destroy: function() {
      this.destroying = true;
      if (this.$content) this.$content.remove();
      if (this.$overlay) this.$overlay.remove();

      delete this.$content;
      delete this.$errorPageFragment;
      delete this.$overlay;
      delete this.$pageDown;
      delete this.$pageUp;
      delete this.$pages;
      delete this.errored;
      delete this.imageFetchQueue;
      delete this.pages;
      delete this.pagesLoaded;
      delete this.resizeHandler;
      delete this.resizeTimeout;
      delete this.rotation;
    },

    open: function() {
      this.destroying = false;
      this.errored = false;
      this.pages = [];
      this.imageFetchQueue = $({});
      this.zoom = false;
      this.$errorPageFragment = $('');
      this.rotation = 0;
      // 1-indexed array populated with "true" if corresponding page has loaded
      this.pagesLoaded = [];

      this.$content = $('<div class="archive-viewer content" style="display: none;"></div>');

      var $toolbarTop = $('<div class="toolbar-top"></div>');

      this.$pageUp = $('<a href="#" class="page-up"><i class="glyphicons-icon white up_arrow"></i></a>').click(
          $.proxy(function() {
            this.pageUp();
            return false;
          }, this));
      $toolbarTop.append(this.$pageUp);

      var $pageIndicator = $('<div class="page-indicator" style=""><div style="height: 21px;">'
          + '<span id="archive-viewer-page-current">' + this.options.page + '</span> / ' + this.options.totalPages
          + (this.options.copies > 1 ? ' </div><div class="copies"> ' + this.options.copies + ' '
              + window.messages.archivingCopies + '</div>' : '')
          + '</div>');
      $toolbarTop.append($pageIndicator);

      this.$pageDown = $('<a href="#" class="page-down"><i class="glyphicons-icon white down_arrow"></i></a>').click(
          $.proxy(function() {
            this.pageDown();
            return false;
          }, this));
      $toolbarTop.append(this.$pageDown);

      var $zoom = $('<a href="#" class="zoom"><i class="glyphicons-icon white zoom_in"></i></a>').click(
          $.proxy(function() {
            this.toggleZoom();
            $i = $zoom.find('i');
            if (this.zoom) {
              $i.removeClass('zoom_in').addClass('zoom_out');
            } else {
              $i.removeClass('zoom_out').addClass('zoom_in');
            }
            return false;
          }, this));
      $toolbarTop.append($zoom);

      var $rotate = $('<a href="#" class="rotate-90-right"><i class="glyphicons-icon white repeat"></i></a>').click(
          $.proxy(function() {
            this.rotate90Right();
            return false;
          }, this));
      $toolbarTop.append($rotate);

      var $download = $('<a href="' + this.downloadUrl
          + '" class="download"><i class="glyphicons-icon white download_alt"></i></a>')
          .attr('title', messages.archivingDownload);
      $toolbarTop.append($download);

      //
      // optionally allow archive removal
      var $archiveRemove = $('<a href="#" class="archive-remove"><i class="glyphicons-icon white bin"></i></a>').click(
              $.proxy(function(e) {
                  this.removeArchive(this.options.jobUid, this.options.archivePath);
                  return false;
              }, this));
      $($archiveRemove).attr('title', window.messages.archivingRemove);

      if (this.options.canAdminRemoveArchive) {
          $toolbarTop.append($archiveRemove);
      } else {
          // compensate for the remove icon not being present and adjust positions of the other items
          $($zoom).css('right', 200);
          $($rotate).css('right', 150);
          $($download).css('right', 100);
      }

      var $close = $('<a href="#" class="close"><i class="glyphicons-icon white remove_2"></i></a>').click(
          $.proxy(function() {
            this.close();
            return false;
          }, this));
      $toolbarTop.append($close);

      this.$content.append($toolbarTop);

      $pagesWrapper = $('<div class="pages-wrapper"></div>');
      this.$pages = $('<div class="pages"></div>');
      this.$pages.click($.proxy(function(event) {
        $target = $(event.target);
        if ($target.hasClass('page') || $target.hasClass('pages')) {
          this.close();
          return false;
        }
      }, this));
      $pagesWrapper.append(this.$pages);
      this.$content.append($pagesWrapper);

      this.resizeHandler = $.proxy(this.resize, this, 500);
      $(window).resize(this.resizeHandler);

      $('body').append(this.$content);
      $('body').css('height', '100%');
      var bodyWidthBefore = $('body').width();
      $('body').css('overflow', 'hidden');
      var bodyWidthAfter = $('body').width();
      /*
       * If the body width has changed we have just dropped the vertical scrollbar. To prevent content jumping, introduce
       * a margin of the same width.
       */
      var scrollBarWidth = bodyWidthAfter - bodyWidthBefore;
      if (scrollBarWidth > 0) {
        $('body').css('margin-right', scrollBarWidth);
      }

      this.keyHandlerProxy = $.proxy(this.keyHandler, this);
      $(window).on('keydown', this.keyHandlerProxy);

      this.$overlay = $.ui.dialog.overlay.create(this).hide().fadeIn(300);
      this.$content.fadeIn(700);
      this.resize();
    },

    removeArchive: function(jobId, archivePath) {
        // confirm deletion
        var response = confirm(window.messages.archivingRemoveConfirm);
        if (response == false)
            // bail out if removal is not positively confirmed
            return;
        // make up archive REST service URI
        var uri = '/archive/' + encodeURIComponent(this.options.archivePath) + '/' + this.options.jobUid;
        var $widget = this;
        // invoke the service to delete the archive using HTTP DELETE
        $.ajax({
            url: uri,
            type: 'DELETE',
            success: function(data) {
                // Upon close of the widget reload the page to force client side to use the latest state on server
                $widget.close();
                $widget.options.reloadAfterClose = true;
            },
            error: function(request, textStatus, errorThrown) {
                alert(window.messages.archivingRemoveError + ": " + request.status + "-" + errorThrown);
            }
        });
    },

    close: function() {
      $(window).unbind('resize', this.resizeHandler);
      if (this.keyHandlerProxy) {
        $(window).off('keydown', this.keyHandlerProxy);
        this.keyHandlerProxy = null;
      }

      this.$content.add(this.$overlay).fadeOut(700).promise().done($.proxy(function() {
        if (this.destroying) return;

        this.$overlay.remove();
        this.$pages.children().remove();
        this.pages.length = 0;
        $('body').css('height', '');
        $('body').css('overflow', '');
        $('body').css('margin-right', 0);

        this.destroy();
        if (this.options.reloadAfterClose) {
            // Update location to invoke refresh link/action on the page
            window.location = $('a#refresh').attr("href");
        }
      }, this));

      this.options.page = 1;
      this.pages = [];
      this.pagesLoaded = [];
    },

    pageUp: function() {
      this.goToPage(this.options.page - 1);
    },

    pageDown: function() {
      // ensure the current page is loaded before being allowed to go to the next page
      if (this.pagesLoaded[this.options.page]) {
        this.goToPage(this.options.page + 1);
      }
    },

    goToPage: function(pageNumber, transitionSpeed, forceLayoutUpdate) {
      transitionSpeed = transitionSpeed == undefined ? this.options.transitionSpeedMs : transitionSpeed;
      forceLayoutUpdate = forceLayoutUpdate == undefined ? false : forceLayoutUpdate;

      if (pageNumber < 1) {
        pageNumber = 1;
      } else if (pageNumber > this.maxPage) {
        pageNumber = this.maxPage;
      }

      // up button is disabled if we're on the first page
      if (pageNumber == 1) {
        this.$pageUp.addClass('disabled');
      } else {
        this.$pageUp.removeClass('disabled');
      }

      // down button is disabled if the next page is not loaded (plus special case - enabled if next page is error page)
      var lastLoadedPageNum = this.pagesLoaded.length - 1;
      if (this.errored && pageNumber == lastLoadedPageNum) {
        this.$pageDown.removeClass('disabled');
      } else if (this.pagesLoaded[pageNumber + 1]) {
        this.$pageDown.removeClass('disabled');
      } else {
        this.$pageDown.addClass('disabled');
      }

      this.addMorePagesIfRequired(pageNumber);

      if (pageNumber == this.options.page && this.pagesLoaded[pageNumber] && !forceLayoutUpdate) {
        return;
      }

      $('.pages').stop().scrollTo($('.page[data-page=' + pageNumber + ']'), transitionSpeed, {
        offset: -70
      });
      this.options.page = pageNumber;
      this.$content.find('#archive-viewer-page-current').text(pageNumber);
    },

    addMorePagesIfRequired: function(pageNumber) {
      var nextPage = Math.min(this.maxPage, pageNumber + 1);

      for (var i = this.pages.length + 1; i <= nextPage; i++) {
        this.appendPage(i);
      }
    },

    appendPage: function(pageNumber) {
      var $page = $('<div class="page" data-page="' + pageNumber + '"><' + '/div>');

      if (pageNumber == this.maxPage && this.truncated) {
        // add the final truncated page
        $page.append($('<div class="content errored"><img src="/images/icons2/128x128/image.png" /><p>'
                        + window.messages.archivingPageLimit + '</p><p><a href="' + this.downloadUrl + '">'
                        + window.messages.archivingViewerDownload + '</a></p></div>'));
        this.pages.push($page);
        this.$pages.append($page);
        return;
      }

      // if any pages have previously errored we don't attempt to add more
      if (this.errored) {
        $page.append(this.$errorPageFragment.clone(true));
        this.pages.push($page);
        this.$pages.append($page);
        return;
      }

      // initialize pages with a loading spinner
      $page.append($('<div class="content loading"><img src="/images/icons2/96x96/loading.gif" /></div>'));
      this.pages.push($page);
      this.$pages.append($page);

      var imageUrl = this.buildUrlForPage(pageNumber);
      var $image = $('<img class="content" />');
      if (this.options.grayscale) $image.addClass('grayscale');

      // queue the image fetching so that we only request one image at a time
      this.imageFetchQueue.queue($.proxy(function(complete) {
        this.pollForImage($image, imageUrl, 1000, $.proxy(function() {
          $image.pcImagesLoaded($.proxy(function() {
            $page.empty().append($image);
            // mark page as loaded
            this.pagesLoaded[pageNumber] = true;

            if (pageNumber == this.options.page + 1) {
              this.$pageDown.removeClass('disabled');
            }
          }, this));

          complete();
        }, this));
      }, this));
    },

    pollForImage: function($image, imageUrl, delay, complete) {
      if (this.destroying) return;

      var imageUrlWithRetry = imageUrl;
      if (this.errorRetry) {
        imageUrlWithRetry += '&retry=true';
        this.errorRetry = false;
      }

      $.ajax(imageUrlWithRetry, {
        type: 'HEAD',
        statusCode: {
          200: function() {
            $image.attr('src', imageUrl);
            complete();
          },
          202: $.proxy(function() {
            setTimeout($.proxy(function() {
              this.pollForImage($image, imageUrl, delay, complete);
            }, this), delay);
          }, this),
          404: $.proxy(function() {
            this.errored = true;
            var errorMsg = messages.archivingPreviewNotArchived;
            this.$errorPageFragment = $('<div class="content errored">'
                + '<img src="/images/icons2/128x128/broken-image.png" /><p>' + errorMsg + '</p></div>');
            // replace all loading images with error images
            this.$pages.find('.page .content.loading').each($.proxy(function(index, element) {
              $(element).replaceWith(this.$errorPageFragment.clone(true));
            }, this));
            this.imageFetchQueue.clearQueue();
          }, this),
          500: $.proxy(function(jqXHR) {
            this.errored = true;
            var response = $.parseJSON(jqXHR.responseText);
            var errorMsg = messages.archivingPreviewNotAvailableError;
            var errorReasons = messages.archivingErrorReasons;
            var allowRetry = true;
            if (response && response.reason && response.reason == 'NotAvailableMissingComponent') {
              errorMsg = messages.archivingPreviewNotAvailableNoConverter
            } else if (response && response.reason && response.reason == 'NotAvailableLessPagesThanExpected') {
              errorMsg = messages.archivingPreviewNotAvailableLessPages
              allowRetry = false;
              errorReasons = null;
            }
            var downloadLink = '<a href="' + this.downloadUrl + '">' + messages.archivingViewerDownload + '</a>';
            this.$errorPageFragment = $('<div class="content errored">'
                + '<img src="/images/icons2/128x128/image.png" />'
                + '<p class="error">' + errorMsg + '</p>'
                + '<p class="download">' + downloadLink + '</p>'
                + (allowRetry ? '<p class="retry"><a href="#">' + messages.archivingRetry + '</a></p>' : '')
                + (errorReasons ? '<p class="error-reasons">' + messages.archivingErrorReasons + '</p>' : '')
                + '</div>');
            if (allowRetry) {
              this.$errorPageFragment.find('.retry a').click($.proxy(function() {
                // reset error flag, remove errored pages, reload the first errored page
                this.errored = false;
                this.errorRetry = true;

                var lastLoadedPageNum = Math.max(this.pagesLoaded.length - 1, 0);
                var selector = '.page';
                if (lastLoadedPageNum > 0) {
                  selector += '[data-page=' + (lastLoadedPageNum) + '] ~ .page';
                }
                this.$pages.find(selector).remove();
                this.pages.splice(lastLoadedPageNum);
                this.addMorePagesIfRequired(this.options.page);
                return false;
              }, this));
            }
            // replace all loading images with error images
            this.$pages.find('.page .content.loading').each($.proxy(function(index, element) {
              $(element).replaceWith(this.$errorPageFragment.clone(true));
            }, this));

            var lastLoadedPageNum = this.pagesLoaded.length - 1;
            if (this.errored && this.options.page == lastLoadedPageNum) {
              this.$pageDown.removeClass('disabled');
            }

            this.imageFetchQueue.clearQueue();
          }, this)
        }
      });
    },

    buildUrlForPage: function(pageNumber) {
      /*
       * When requesting page 1, request that pages up to 4 are created in advance (the initial set).
       * When requesting page 3, request that pages up to 50 are created in advance.
       * When requesting page 30, request that the maximum number of pages are created in advance.
       */
      var pagesToRenderAbs = 1;
      if (pageNumber >= 30) {
        pagesToRenderAbs = this.options.totalPages;
      } else if (pageNumber >= 3) {
        pagesToRenderAbs = Math.min(this.options.totalPages, 50);
      } else {
        pagesToRenderAbs = 4;
      }
      pagesToRenderAbs = Math.min(pagesToRenderAbs, this.options.pageLimit);
      var pagesToRenderAddl = pagesToRenderAbs - pageNumber + 1;

      var url = '/archive/image/' + encodeURIComponent(this.options.archivePath) + '/' + this.options.jobUid + '/page'
                  + pageNumber + '.png?pages=' + pagesToRenderAddl;

      return url;
    },

    keyHandler: function(event) {
      switch (event.keyCode) {
        // page up
        case 33:
        // up arrow
        case 38:
        // numlock numpad up
        case 104:
          this.pageUp();
          return false;

        // page down
        case 34:
        // down arrow
        case 40:
        // numlock numpad down
        case 98:
          this.pageDown();
          return false;

        // home
        case 36:
          this.goToPage(1);
          return false;

        // end
        case 35:
          // don't go to last page, just prevent scrolling in parent
          return false;

        // delete
        case 46:
          if (this.options.canAdminRemoveArchive)
              this.removeArchive(this.options.jobUid, this.options.archivePath);
          return false;

        // esc
        case 27:
          this.close();
          return false;
      }
    },

    toggleZoom: function() {
      this.zoom = !this.zoom;
      this.resize();
    },

    rotate90Right: function() {
      this.rotation += 90;

      // just animate the current page (prevents animation from other pages coming into view)
      var $currentImg = $('.page[data-page=' + this.options.page + '] img');
      $currentImg.css({
        '-webkit-transition': 'all 0.3s',
        '-moz-transition': 'all 0.3s',
        '-o-transition': 'all 0.3s',
        'transition': 'all 0.3s'
      });
      setTimeout(function() {
        $currentImg.attr('style', '');
      }, 300);

      this.resize();
    },

    resize: function(delay) {
      clearTimeout(this.resizeTimeout);
      this.resizeTimeout = setTimeout($.proxy(function() {
        if (this.destroying) return;

        // constrain image height to slightly less than the viewable area height
        var maxHeight = this.$pages.parent().height() - 80;
        var loadingHeight = maxHeight;
        // looks like paper dimensions
        var loadingWidth = maxHeight * 0.71;
        var imgMaxHeight = this.zoom ? 'none' : maxHeight + 'px';
        var transform = 'rotate(' + this.rotation + 'deg)';
        setGlobalCSS({
          '.archive-viewer .pages .page img.content': 'max-height: ' + imgMaxHeight + ';'
              + '-webkit-transform: ' + transform + ';'
              + '-moz-transform: ' + transform + ';'
              + '-ms-transform: ' + transform + ';'
              + '-o-transform: ' + transform + ';'
              + 'transform: ' + transform + ';',
          '.archive-viewer .pages .page .content.loading': 'width: ' + loadingWidth + 'px; height: ' + loadingHeight
              + 'px;',
          '.archive-viewer .pages .page .content.errored': 'width: ' + loadingWidth + 'px; height: ' + loadingHeight
              + 'px;'
        });
        this.goToPage(this.options.page, 0, true);
      }, this), delay);
    }
  });
}

$(function () {
  var fetchSupportInformation = function(callback, prefetch) {
      $.get('/rpc/api/rest/internal/adminui/applicationlicense' + (prefetch  ? "?prefetch=true" : ""))
        .done(function (internalData) {
          if (internalData.supportInformationUrl) {
            $.ajax(internalData.supportInformationUrl,
                {
                  dataType: 'jsonp',
                  timeout: 3000,
                  jsonpCallback: 'jsonpCallback',
                  cache: true
                }
              )
              .done(function(newInfo) {
                callback($.extend(internalData, newInfo));
              })
              .fail(function () {
                callback(internalData);
              });
          } else {
            callback(internalData);
          }
        });
  }
  $('.support-information').each(function(i, el) {
    var renderSupportInformation = function(info) {
      var emailSubject = "[Your subject here] - Support request for " + info.applicationName + " "
          + info.applicationFullVersion;

      var emailBodyTemplate = Handlebars.compile('\n===========================\n\
Application:               {{applicationName}}\n\
Version:                   {{applicationFullVersion}}\n\
Platform:                  {{platformInfo}}\n\
Modules:                   {{modules}}\n\
Licensed to:               {{orgName}}\n\
{{#if orgType}}\
Org Type:                  {{orgType}}\n\
{{/if}}Install Date:              {{installDate}}\n\
Support ID:                {{supportId}}\n\
{{#if supporExpiryDate}}\
Support until:             {{supportExpiryDate}}\n\
{{/if}}\
Licensed users:            {{users}}\n\
Current users:             {{usersUsed}}\n\
Licensed release stations: {{releaseStations}}\n\
Database:                  {{databaseType}}\n\
===========================\n');

      var supportMailToLink = "mailto:" + info.supportEmail + "?subject=" + encodeURIComponent(emailSubject)
          + "&body=" + encodeURIComponent(emailBodyTemplate(info));

      var $el = $(el);

      if (info.supportEmail) {
          $el.find("#support-email-link").attr("href", supportMailToLink).html(info.supportEmail);
          $el.find('#support-email').show();
      }

      if (info.supportPhone) {
          $el.find("#support-phone-value").html(info.supportPhone);
          $el.find('#support-phone').show();
      }

      if (info.supportUrl) {
          $el.find("#support-url-link").attr("href", info.supportUrl);
          $el.find('#support-url').show();
      }

      if (info.resellerEmail || info.resellerUrl || info.resellerPhone) {
          if (info.resellerUrl) {
              if (info.resellerName) {
                $el.find('a.reseller-url').attr('href', info.resellerUrl).html(info.resellerName);
              } else {
                $el.find('a.reseller-url').attr('href', info.resellerUrl);
              }

          } else {
              $el.find('a.reseller-url').remove();
          }

          if (info.resellerImageUrl) {
              var $image = $('<img/>').attr('src', info.resellerImageUrl);
              if (info.resellerUrl) {
                  $image = $('<a/>').attr('href', info.resellerUrl).append($image).attr('target', '_blank');
              }
              $el.find('.reseller-logo').append($image);
          } else {
              $el.find('.reseller-logo').remove();
          }

          if (info.resellerEmail) {
              $el.find('a.reseller-email').text(info.resellerEmail).attr('href', 'mailto:' + info.resellerEmail);
          } else {
              $el.find('a.reseller-email').remove();
          }

          if (info.resellerPhone) {
              $el.find('span.reseller-phone').text(info.resellerPhone);
          } else {
              $el.find('span.reseller-phone').remove();
          }

          $(el).find('.reseller-information').show();
      }
    };

    fetchSupportInformation(renderSupportInformation, false);
  });

  $('.support-information-prefetch').each(function () {
    fetchSupportInformation(function () {}, true);
  });
});